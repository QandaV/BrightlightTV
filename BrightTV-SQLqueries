SELECT *
FROM BRIGHTLIGHT.PUBLIC.USERPROFILES;

SELECT *
FROM BRIGHTLIGHT.PUBLIC.MERGED_VIEWERSHIPPROFILE;

SELECT *
FROM BRIGHTLIGHT.PUBLIC.VIEWERSHIP;

---Merged the tables
CREATE OR REPLACE TABLE  MERGED_VIEWERSHIPPROFILE AS
SELECT *
FROM BRIGHTLIGHT.PUBLIC.USERPROFILES AS A
FULL OUTER JOIN BRIGHTLIGHT.PUBLIC.VIEWERSHIP AS B
ON A.USERID =B."UserID";

---- Create Additional Column to create a column of Morning, Afternoon, Evening and LateNight

CREATE OR REPLACE TABLE  MERGED_VIEWERSHIPPROFILE AS
SELECT
*,
CASE
    WHEN TIME_OF_DAY:: TIME BETWEEN TIME('1:00:00') AND TIME('11:59:59') THEN  'Morning'
    WHEN TIME_OF_DAY:: TIME BETWEEN TIME('12:00:00') AND TIME('15:59:59') THEN  'Afternoon'
    WHEN TIME_OF_DAY:: TIME BETWEEN TIME('16:00:00') AND TIME('21:59:59') THEN  'Night'
    ELSE 'LateNight'
    END AS Viewing_Times,
CASE
    WHEN AGE BETWEEN 0 AND 15 THEN 'Children'
    WHEN AGE BETWEEN 16 AND 24 THEN 'Youth'
    WHEN AGE BETWEEN 25 AND 44 THEN 'Young Adults'
    WHEN AGE BETWEEN 45 AND 64 THEN 'Middle-Aged Adults'
    ELSE 'Seniors'
    END AS Age_Group    
FROM BRIGHTLIGHT.PUBLIC.USERPROFILES AS A
FULL OUTER JOIN BRIGHTLIGHT.PUBLIC.VIEWERSHIP AS B
ON A.USERID =B."UserID";


----Isolate those with an ID but without viewing history
SELECT *
FROM MERGED_VIEWERSHIPPROFILE
WHERE
  (recorddate2 IS NULL)
  AND
  (channel2 IS NULL);

---Isolating with ID but no viewing info

CREATE OR REPLACE TABLE CLEANEDVIEWING_TIMES AS
SELECT 
  *,
  CASE
    WHEN viewing_times IS NULL OR viewing_times = '' OR duration2 IS NULL THEN 'No Activity'
    ELSE 'Has Activity'
  END AS Activity_Status
FROM MERGED_VIEWERSHIPPROFILE;

SELECT *
FROM BRIGHTLIGHT.PUBLIC.CLEANEDVIEWING_TIMES;

---- Summary table Users per Active or Inactive
SELECT 
  Activity_Status,
  COUNT(DISTINCT USERID) AS User_Count
FROM CLEANEDVIEWING_TIMES
GROUP BY Activity_Status;

---- Eliminate USERIDs without viewing times
CREATE OR REPLACE TABLE CLEANEDVIEWING_TIMES AS
SELECT 
  *,
  'Has Activity' AS Activity_Status
FROM MERGED_VIEWERSHIPPROFILE
WHERE viewing_times IS NOT NULL 
  AND viewing_times <> ''
  AND duration2 IS NOT NULL;

